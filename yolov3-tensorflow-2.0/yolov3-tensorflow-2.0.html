<head>
    <!-- Global site tag (gtag.js) - Google Analytics -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=UA-160773620-1"></script>
        <script>
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());

          gtag('config', 'UA-160773620-1');
        </script>
  <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<!-- Fontawesome -->
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.4.2/css/all.css" integrity="sha384-/rXc/GQVaYpyDdyxK+ecHPVYJSN9bmVFBvjA/9eOB+pb3F2w2N6fc5qB9Ew5yIns" crossorigin="anonymous">

<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css?family=Lexend+Deca|Noto+Sans:600|Work+Sans:400,500|Playfair+Display+SC:700&display=swap" rel="stylesheet">

<!-- Bootstrap CSS -->
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

<!-- CSS sheets -->
<link rel="stylesheet" href="../style/index.css?v=<?=time();?>" type="text/css"/>
<title>Timothy Delille</title>

  <style type="text/css">
    .highlight .hll { background-color: #ffffcc }
.highlight  { background: #f8f8f8; }
.highlight .c { color: #408080; font-style: italic } /* Comment */
.highlight .err { border: 1px solid #FF0000 } /* Error */
.highlight .k { color: #008000; font-weight: bold } /* Keyword */
.highlight .o { color: #666666 } /* Operator */
.highlight .ch { color: #408080; font-style: italic } /* Comment.Hashbang */
.highlight .cm { color: #408080; font-style: italic } /* Comment.Multiline */
.highlight .cp { color: #BC7A00 } /* Comment.Preproc */
.highlight .cpf { color: #408080; font-style: italic } /* Comment.PreprocFile */
.highlight .c1 { color: #408080; font-style: italic } /* Comment.Single */
.highlight .cs { color: #408080; font-style: italic } /* Comment.Special */
.highlight .gd { color: #A00000 } /* Generic.Deleted */
.highlight .ge { font-style: italic } /* Generic.Emph */
.highlight .gr { color: #FF0000 } /* Generic.Error */
.highlight .gh { color: #000080; font-weight: bold } /* Generic.Heading */
.highlight .gi { color: #00A000 } /* Generic.Inserted */
.highlight .go { color: #888888 } /* Generic.Output */
.highlight .gp { color: #000080; font-weight: bold } /* Generic.Prompt */
.highlight .gs { font-weight: bold } /* Generic.Strong */
.highlight .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.highlight .gt { color: #0044DD } /* Generic.Traceback */
.highlight .kc { color: #008000; font-weight: bold } /* Keyword.Constant */
.highlight .kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
.highlight .kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
.highlight .kp { color: #008000 } /* Keyword.Pseudo */
.highlight .kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
.highlight .kt { color: #B00040 } /* Keyword.Type */
.highlight .m { color: #666666 } /* Literal.Number */
.highlight .s { color: #BA2121 } /* Literal.String */
.highlight .na { color: #7D9029 } /* Name.Attribute */
.highlight .nb { color: #008000 } /* Name.Builtin */
.highlight .nc { color: #0000FF; font-weight: bold } /* Name.Class */
.highlight .no { color: #880000 } /* Name.Constant */
.highlight .nd { color: #AA22FF } /* Name.Decorator */
.highlight .ni { color: #999999; font-weight: bold } /* Name.Entity */
.highlight .ne { color: #D2413A; font-weight: bold } /* Name.Exception */
.highlight .nf { color: #0000FF } /* Name.Function */
.highlight .nl { color: #A0A000 } /* Name.Label */
.highlight .nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
.highlight .nt { color: #008000; font-weight: bold } /* Name.Tag */
.highlight .nv { color: #19177C } /* Name.Variable */
.highlight .ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
.highlight .w { color: #bbbbbb } /* Text.Whitespace */
.highlight .mb { color: #666666 } /* Literal.Number.Bin */
.highlight .mf { color: #666666 } /* Literal.Number.Float */
.highlight .mh { color: #666666 } /* Literal.Number.Hex */
.highlight .mi { color: #666666 } /* Literal.Number.Integer */
.highlight .mo { color: #666666 } /* Literal.Number.Oct */
.highlight .sa { color: #BA2121 } /* Literal.String.Affix */
.highlight .sb { color: #BA2121 } /* Literal.String.Backtick */
.highlight .sc { color: #BA2121 } /* Literal.String.Char */
.highlight .dl { color: #BA2121 } /* Literal.String.Delimiter */
.highlight .sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
.highlight .s2 { color: #BA2121 } /* Literal.String.Double */
.highlight .se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */
.highlight .sh { color: #BA2121 } /* Literal.String.Heredoc */
.highlight .si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */
.highlight .sx { color: #008000 } /* Literal.String.Other */
.highlight .sr { color: #BB6688 } /* Literal.String.Regex */
.highlight .s1 { color: #BA2121 } /* Literal.String.Single */
.highlight .ss { color: #19177C } /* Literal.String.Symbol */
.highlight .bp { color: #008000 } /* Name.Builtin.Pseudo */
.highlight .fm { color: #0000FF } /* Name.Function.Magic */
.highlight .vc { color: #19177C } /* Name.Variable.Class */
.highlight .vg { color: #19177C } /* Name.Variable.Global */
.highlight .vi { color: #19177C } /* Name.Variable.Instance */
.highlight .vm { color: #19177C } /* Name.Variable.Magic */
.highlight .il { color: #666666 } /* Literal.Number.Integer.Long */
      
      
#notebook-container {
    padding: 15px;
    background-color: #fff;
    min-height: 0;
    -webkit-box-shadow: 0px 0px 12px 1px rgba(87, 87, 87, 0.2);
    box-shadow: 0px 0px 12px 1px rgba(87, 87, 87, 0.2);
  }
      .input_prompt{
          display:none;
      }
  </style>
  

  <!-- Loading mathjax macro -->
  <!-- Load mathjax -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS_HTML"></script>
    <!-- MathJax configuration -->
    <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ['$','$'], ["\\(","\\)"] ],
            displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
            processEscapes: true,
            processEnvironments: true
        },
        // Center justify equations in code and markdown cells. Elsewhere
        // we use CSS to left justify single line equations in code cells.
        displayAlign: 'center',
        "HTML-CSS": {
            styles: {'.MathJax_Display': {"margin": 0}},
            linebreaks: { automatic: true }
        }
    });
    </script>
    <!-- End of mathjax configuration -->
</head>
<html>
<body class='bg-light'>
    <nav class="navbar navbar-expand-lg navbar-light scroll-fade">
  <img class='mx-auto' src='../Delille_Timothy.jpg' style='width:3rem;border-radius:50%;'/>
  <h3 class='ml-2'><a href='../index.html'>Timothy Delille</a></h3>
  <button class="navbar-toggler ml-auto" type="button" data-toggle="collapse" data-target="#navbarNavDropdown" aria-controls="navbarNavDropdown" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>
  <div class="collapse navbar-collapse" id="navbarNavDropdown">
    <ul class="navbar-nav ml-auto">
      <li class="nav-item active">
        <a class="nav-link" href="../index.html">Work <span class="sr-only">(current)</span></a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="#">About</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="#">Resume</a>
      </li>
    </ul>
  </div>
</nav>
<div id="particles-js" class='col d-none d-md-block' style='height:10rem;'></div>

  <div tabindex="-1" id="notebook" class="border-box-sizing">
    <div class="container" id="notebook-container">

<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 class='m-0 mt-3 d-none d-lg-block' id="YOLOv3:-a-Tensorflow-2.0-Implementation">YOLOv3: a Tensorflow 2.0 Implementation<a class="anchor-link" href="#YOLOv3:-a-Tensorflow-2.0-Implementation">&#182;</a></h1>
<h2 class='m-0 mt-3 d-sm-block d-lg-none' id="YOLOv3:-a-Tensorflow-2.0-Implementation">YOLOv3: a Tensorflow 2.0 Implementation<a class="anchor-link" href="#YOLOv3:-a-Tensorflow-2.0-Implementation">&#182;</a></h2>
<p>I propose an implementation of YOLOv3 using Tensorflow 2.0. For example purposes, I use the <a href="https://www.cis.upenn.edu/~jshi/ped_html/">Penn-Fudan Database for Pedestrian Detection and Segmentation</a>.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Import-modules">Import modules<a class="anchor-link" href="#Import-modules">&#182;</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[1]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="ch">#!pip install tensorflow==2.0.0-beta1 </span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">import</span> <span class="nn">tensorflow.keras.layers</span>
<span class="kn">import</span> <span class="nn">cv2</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">csv</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="nb">print</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span> <span class="c1">#must be 2.0.0-beat1</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt"></div>


<div class="output_subarea output_stream output_stdout output_text">
<pre>2.0.0-beta1
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Hyper-parameters">Hyper-parameters<a class="anchor-link" href="#Hyper-parameters">&#182;</a></h2><p>We use the parameters set in the original publication <a href="https://arxiv.org/abs/1804.02767">YOLOv3</a>. Ideally, one should perform k-means clustering on the training dataset to find the proper anchors.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[2]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">BBOXES_PER_CELL</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">ANCHORS_SMALL</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">([[</span><span class="mi">10</span><span class="p">,</span><span class="mi">13</span><span class="p">],[</span><span class="mi">16</span><span class="p">,</span><span class="mi">30</span><span class="p">],[</span><span class="mi">33</span><span class="p">,</span><span class="mi">23</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="c1">#we should do k-means clustering on our dataset</span>
<span class="n">ANCHORS_MEDIUM</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">([[</span><span class="mi">30</span><span class="p">,</span><span class="mi">61</span><span class="p">],[</span><span class="mi">62</span><span class="p">,</span><span class="mi">45</span><span class="p">],[</span><span class="mi">59</span><span class="p">,</span><span class="mi">119</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">ANCHORS_LARGE</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">([[</span><span class="mi">116</span><span class="p">,</span><span class="mi">90</span><span class="p">],[</span><span class="mi">156</span><span class="p">,</span><span class="mi">198</span><span class="p">],[</span><span class="mi">373</span><span class="p">,</span><span class="mi">326</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">INPUT_SIZE</span> <span class="o">=</span> <span class="mi">416</span>
<span class="n">CLASSES_LIST</span> <span class="o">=</span><span class="p">[</span><span class="s1">&#39;Distracted Person&#39;</span><span class="p">,</span> <span class="s1">&#39;Person&#39;</span><span class="p">]</span>
<span class="n">DISPLAY_CLASSES_LIST</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Distracted Person&#39;</span><span class="p">,</span> <span class="s1">&#39;Person&#39;</span><span class="p">]</span>
<span class="n">COLORS</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,</span><span class="mi">255</span><span class="p">,</span><span class="mi">255</span><span class="p">),(</span><span class="mi">0</span><span class="p">,</span><span class="mi">255</span><span class="p">,</span><span class="mi">0</span><span class="p">)]</span>
<span class="n">BATCH_NORM_MOMENTUM</span> <span class="o">=</span> <span class="mf">0.9</span>
<span class="n">BATCH_NORM_EPSILON</span> <span class="o">=</span> <span class="mf">1e-05</span>
<span class="n">LEAKY_RELU</span> <span class="o">=</span> <span class="mf">0.1</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="YOLOv3-Architecture">YOLOv3 Architecture<a class="anchor-link" href="#YOLOv3-Architecture">&#182;</a></h2><p>We use the architecture from the original paper:</p>

<p align="center">
    <img src="yolov3_architecture.png" class='img-fluid' width="600rem"/>
</p>
    
<center>Overview of the YOLOv3 architecture</center><p><a href="https://www.cyberailab.com/home/a-closer-look-at-yolov3">Reference</a></p>
<p>The input images should be in shape <code>(416, 416, 3)</code> (3 channels for RGB). We might have to resize and pad the input images. The images are in batches of shape: <code>(batch size, 416, 416, 3)</code></p>
<p align="center">
    <img src="Picture1.png" class='img-fluid' width="150rem"/>
</p>
<p>This tensor is fed through the network:</p>
<p align="center">
    <img src="Picture2.png" class='img-fluid' width="350rem"/>
</p>
<p>And outputs a tensor of shape <code>(N*N*[3*(4 coordinates + 1 objectness score + n classes)]</code> for each scale:</p>
<p align="center">
    <img src="Picture3.png" class='img-fluid' width="350rem"/>
</p>
<p>Here is the output for the three scales and the whole batch:</p>
<p align="center">
    <img src="Picture4.png" class='img-fluid' width="350rem"/>
</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[3]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">convolution</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">filters</span><span class="p">,</span> <span class="n">kernel_size</span><span class="p">,</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">use_bias</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="n">filters</span><span class="p">,</span> <span class="n">kernel_size</span><span class="p">,</span> <span class="n">strides</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span> <span class="n">use_bias</span><span class="o">=</span><span class="kc">True</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span> <span class="c1">#padding=&#39;same&#39; so that convolution works out: (416-3)/2 + 1 -&gt; 208 and not 207</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">BatchNormalization</span><span class="p">(</span><span class="n">momentum</span><span class="o">=</span><span class="n">BATCH_NORM_MOMENTUM</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="n">BATCH_NORM_EPSILON</span><span class="p">,</span> <span class="n">trainable</span><span class="o">=</span><span class="kc">True</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">LeakyReLU</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="n">LEAKY_RELU</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span>

<span class="k">def</span> <span class="nf">residual_block</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">filters</span><span class="p">):</span>
    <span class="n">shortcut</span> <span class="o">=</span> <span class="n">x</span> <span class="c1"># 208</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">convolution</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">filters</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span> <span class="c1">#(208-1)/1 +1 = 208</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">convolution</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">filters</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="c1">#(208-3)/1 + 1 = 206</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Add</span><span class="p">()([</span><span class="n">shortcut</span><span class="p">,</span> <span class="n">x</span><span class="p">])</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">activations</span><span class="o">.</span><span class="n">linear</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span>
  
<span class="k">def</span> <span class="nf">darknet53</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">convolution</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="c1">#(416-3)/1 + 1 = 414</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">convolution</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span> <span class="c1">#(414-3)/2 + 1 = 208 (we take the sup)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">residual_block</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">64</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">convolution</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span><span class="c1">#(208-3)/2 + 1 = 104</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">residual_block</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">128</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">convolution</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span> <span class="c1">#(104-3)/2 + 1 = 52</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">residual_block</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">256</span><span class="p">)</span>
    <span class="n">scale11</span> <span class="o">=</span> <span class="n">x</span> <span class="c1">#52</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">convolution</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span> <span class="c1">#(52-3)/2 + 1 = 26</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">residual_block</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">512</span><span class="p">)</span>
    <span class="n">scale21</span> <span class="o">=</span> <span class="n">x</span> <span class="c1">#26</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">convolution</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">residual_block</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">1024</span><span class="p">)</span>
    <span class="n">scale22</span> <span class="o">=</span> <span class="n">x</span>
    <span class="n">scale3</span> <span class="o">=</span> <span class="n">x</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">convolution</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">convolution</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    
    <span class="n">scale3</span> <span class="o">=</span> <span class="n">convolution</span><span class="p">(</span><span class="n">scale3</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">scale22</span> <span class="o">=</span> <span class="n">convolution</span><span class="p">(</span><span class="n">scale22</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">scale22</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">UpSampling2D</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)(</span><span class="n">scale22</span><span class="p">)</span>
    <span class="n">scale2</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Concatenate</span><span class="p">(</span><span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)([</span><span class="n">scale21</span><span class="p">,</span><span class="n">scale22</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">scale2</span> <span class="o">=</span> <span class="n">convolution</span><span class="p">(</span><span class="n">scale2</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">scale2</span> <span class="o">=</span> <span class="n">convolution</span><span class="p">(</span><span class="n">scale2</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">scale12</span> <span class="o">=</span> <span class="n">scale2</span>
    <span class="n">scale2</span> <span class="o">=</span> <span class="n">convolution</span><span class="p">(</span><span class="n">scale2</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">scale12</span> <span class="o">=</span> <span class="n">convolution</span><span class="p">(</span><span class="n">scale12</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">scale12</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">UpSampling2D</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)(</span><span class="n">scale12</span><span class="p">)</span>
    <span class="n">scale1</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Concatenate</span><span class="p">(</span><span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)([</span><span class="n">scale11</span><span class="p">,</span> <span class="n">scale12</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">scale1</span> <span class="o">=</span> <span class="n">convolution</span><span class="p">(</span><span class="n">scale1</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">scale1</span> <span class="o">=</span> <span class="n">convolution</span><span class="p">(</span><span class="n">scale1</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">scale1</span> <span class="o">=</span> <span class="n">convolution</span><span class="p">(</span><span class="n">scale1</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    
    <span class="n">scale1</span> <span class="o">=</span> <span class="n">convolution</span><span class="p">(</span><span class="n">scale1</span><span class="p">,</span> <span class="mi">3</span><span class="o">*</span><span class="p">(</span><span class="mi">5</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">CLASSES_LIST</span><span class="p">)),</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">scale2</span> <span class="o">=</span> <span class="n">convolution</span><span class="p">(</span><span class="n">scale2</span><span class="p">,</span> <span class="mi">3</span><span class="o">*</span><span class="p">(</span><span class="mi">5</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">CLASSES_LIST</span><span class="p">)),</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">scale3</span> <span class="o">=</span> <span class="n">convolution</span><span class="p">(</span><span class="n">scale3</span><span class="p">,</span> <span class="mi">3</span><span class="o">*</span><span class="p">(</span><span class="mi">5</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">CLASSES_LIST</span><span class="p">)),</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">scale1</span> <span class="o">=</span> <span class="n">decode</span><span class="p">(</span><span class="n">scale1</span><span class="p">,</span> <span class="n">ANCHORS_SMALL</span><span class="p">)</span>
    <span class="n">scale2</span> <span class="o">=</span> <span class="n">decode</span><span class="p">(</span><span class="n">scale2</span><span class="p">,</span> <span class="n">ANCHORS_MEDIUM</span><span class="p">)</span>
    <span class="n">scale3</span> <span class="o">=</span> <span class="n">decode</span><span class="p">(</span><span class="n">scale3</span><span class="p">,</span> <span class="n">ANCHORS_LARGE</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">scale1</span><span class="p">,</span> <span class="n">scale2</span><span class="p">,</span> <span class="n">scale3</span>

<span class="k">def</span> <span class="nf">IOU</span><span class="p">(</span><span class="n">bp</span><span class="p">,</span> <span class="n">bt</span><span class="p">):</span>
    <span class="n">xminp</span><span class="p">,</span> <span class="n">yminp</span><span class="p">,</span> <span class="n">xmaxp</span><span class="p">,</span> <span class="n">ymaxp</span> <span class="o">=</span> <span class="n">bp</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">bp</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">bp</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">bp</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span>
    <span class="n">xmint</span><span class="p">,</span> <span class="n">ymint</span><span class="p">,</span> <span class="n">xmaxt</span><span class="p">,</span> <span class="n">ymaxt</span> <span class="o">=</span> <span class="n">bt</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">bt</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">bt</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">bt</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span>
    
    <span class="n">xminp</span><span class="p">,</span> <span class="n">xmaxp</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">xminp</span><span class="p">,</span><span class="n">xmaxp</span><span class="p">),</span> <span class="n">tf</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">xminp</span><span class="p">,</span><span class="n">xmaxp</span><span class="p">)</span>
    <span class="n">yminp</span><span class="p">,</span> <span class="n">ymaxp</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">yminp</span><span class="p">,</span><span class="n">ymaxp</span><span class="p">),</span> <span class="n">tf</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">yminp</span><span class="p">,</span><span class="n">ymaxp</span><span class="p">)</span>
    <span class="n">xmint</span><span class="p">,</span> <span class="n">xmaxt</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">xmint</span><span class="p">,</span><span class="n">xmaxt</span><span class="p">),</span> <span class="n">tf</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">xmint</span><span class="p">,</span><span class="n">xmaxt</span><span class="p">)</span>
    <span class="n">ymint</span><span class="p">,</span> <span class="n">ymaxt</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">ymint</span><span class="p">,</span><span class="n">ymaxt</span><span class="p">),</span> <span class="n">tf</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">ymint</span><span class="p">,</span><span class="n">ymaxt</span><span class="p">)</span>
    <span class="n">area_p</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">xmaxp</span><span class="p">,</span><span class="n">xminp</span><span class="p">),</span> <span class="n">tf</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">ymaxp</span><span class="p">,</span><span class="n">yminp</span><span class="p">))</span>
    <span class="n">area_t</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">xmaxt</span><span class="p">,</span><span class="n">xmint</span><span class="p">),</span> <span class="n">tf</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">ymaxt</span><span class="p">,</span><span class="n">ymint</span><span class="p">))</span>
    <span class="n">xI_1</span><span class="p">,</span> <span class="n">xI_2</span><span class="p">,</span> <span class="n">yI_1</span><span class="p">,</span> <span class="n">yI_2</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">xminp</span><span class="p">,</span> <span class="n">xmint</span><span class="p">),</span> <span class="n">tf</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">xmaxp</span><span class="p">,</span> <span class="n">xmaxt</span><span class="p">),</span> <span class="n">tf</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">yminp</span><span class="p">,</span> <span class="n">ymint</span><span class="p">),</span> <span class="n">tf</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">ymaxp</span><span class="p">,</span> <span class="n">ymaxt</span><span class="p">)</span>
  
    <span class="n">cond</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">greater</span><span class="p">(</span><span class="n">xI_2</span><span class="p">,</span> <span class="n">xI_1</span><span class="p">),</span> <span class="n">tf</span><span class="o">.</span><span class="n">greater</span><span class="p">(</span><span class="n">yI_2</span><span class="p">,</span> <span class="n">yI_1</span><span class="p">))</span>
    <span class="n">I</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">xI_2</span><span class="p">,</span> <span class="n">xI_1</span><span class="p">),</span> <span class="n">tf</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">yI_2</span><span class="p">,</span> <span class="n">yI_1</span><span class="p">))</span>
    <span class="n">true_mask</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">bool</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">I</span><span class="o">.</span><span class="n">numpy</span><span class="p">()))</span>
    <span class="n">zeros</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">I</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">I</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">I</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cond</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">zeros</span><span class="p">)</span>                
    
    <span class="n">U</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">area_p</span><span class="p">,</span> <span class="n">area_t</span><span class="p">),</span> <span class="n">I</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">I</span><span class="p">,</span><span class="n">U</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Preprocess,-Post-process-and-ground-truth">Preprocess, Post-process and ground-truth<a class="anchor-link" href="#Preprocess,-Post-process-and-ground-truth">&#182;</a></h2><p>We have to modify the training images so that they match the output (in order to compare output and ground-truth)
When training or running inference, the image goes through the following pipeline:</p>
<ol>
<li>its dimensions are modified to match the target size of <code>416x416</code> (with zero padding)</li>
<li>the input is processed through the network</li>
<li>the network outputs three tensors (one for each scale)</li>
<li>the tensors are decoded according to the formula in the original paper and brought back to scale (with <code>416x416</code>dimension instead of relative offsets)</li>
<li>we perform non-max suppression on the scales to eliminate low objectness scores and redundant bounding boxes</li>
<li>the scales are brought back to the image's original width and height</li>
<li>we draw bounding boxes on the image</li>
</ol>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[4]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">image_preprocess</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">bboxes</span><span class="p">,</span> <span class="n">target_size</span><span class="o">=</span><span class="p">(</span><span class="n">INPUT_SIZE</span><span class="p">,</span><span class="n">INPUT_SIZE</span><span class="p">)):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    bboxes = [[xmin,ymin,xmax,ymax],[]] for one image</span>
<span class="sd">    resizes image and adds zero padding so that it is 416*416</span>
<span class="sd">    updates the bboxes (nparray) to match the new image</span>
<span class="sd">    returns the new image as nparray and y_true as a dict &#39;classes&#39; and &#39;bboxes&#39; (nparray)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ih</span><span class="p">,</span> <span class="n">iw</span>    <span class="o">=</span> <span class="n">target_size</span>
    <span class="n">h</span><span class="p">,</span>  <span class="n">w</span><span class="p">,</span> <span class="n">_</span>  <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span>

    <span class="n">scale</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">iw</span><span class="o">/</span><span class="n">w</span><span class="p">,</span> <span class="n">ih</span><span class="o">/</span><span class="n">h</span><span class="p">)</span>
    <span class="n">nw</span><span class="p">,</span> <span class="n">nh</span>  <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">scale</span> <span class="o">*</span> <span class="n">w</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">scale</span> <span class="o">*</span> <span class="n">h</span><span class="p">)</span>
    <span class="n">image_resized</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="p">(</span><span class="n">nw</span><span class="p">,</span> <span class="n">nh</span><span class="p">))</span>
    

    <span class="n">image_paded</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ih</span><span class="p">,</span> <span class="n">iw</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
    <span class="n">dw</span><span class="p">,</span> <span class="n">dh</span> <span class="o">=</span> <span class="p">(</span><span class="n">iw</span><span class="o">-</span><span class="n">nw</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="n">ih</span><span class="o">-</span><span class="n">nh</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
    <span class="n">image_paded</span><span class="p">[</span><span class="n">dh</span><span class="p">:</span><span class="n">nh</span><span class="o">+</span><span class="n">dh</span><span class="p">,</span> <span class="n">dw</span><span class="p">:</span><span class="n">nw</span><span class="o">+</span><span class="n">dw</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">image_resized</span> <span class="c1">#the original image is centered</span>
    <span class="n">image_paded</span> <span class="o">=</span> <span class="n">image_paded</span> <span class="o">/</span> <span class="mf">255.</span>
    
    <span class="n">bboxes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">bboxes</span><span class="p">)</span><span class="o">*</span><span class="n">scale</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">dw</span><span class="p">,</span> <span class="n">dh</span><span class="p">,</span> <span class="n">dw</span><span class="p">,</span> <span class="n">dh</span><span class="p">])</span> <span class="c1">#bboxes = [[xmin,ymin,xmax,ymax]]</span>
    <span class="k">return</span> <span class="n">image_paded</span><span class="p">,</span> <span class="n">bboxes</span>

<span class="k">def</span> <span class="nf">ground_truth_preprocess</span><span class="p">(</span><span class="n">classes</span><span class="p">,</span> <span class="n">bboxes</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    classes = [class1, class2], bboxes=[[xmin, ymin, xmax, ymax],[]] for ONE image</span>
<span class="sd">    returns 3 arrays of shape (N, N, 3, 5+num_classes) (one for each scale) scale = [[bx,by,bw,bh,conf,probs],[]]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">scale1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">52</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="n">BBOXES_PER_CELL</span><span class="p">,</span> <span class="mi">5</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">CLASSES_LIST</span><span class="p">)))</span>
    <span class="n">scale2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">26</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="n">BBOXES_PER_CELL</span><span class="p">,</span> <span class="mi">5</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">CLASSES_LIST</span><span class="p">)))</span>
    <span class="n">scale3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">13</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="n">BBOXES_PER_CELL</span><span class="p">,</span> <span class="mi">5</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">CLASSES_LIST</span><span class="p">)))</span>
    <span class="n">bboxes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">bboxes</span><span class="p">)</span>
    <span class="n">bboxes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">bboxes</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span> <span class="c1">#unspecified value -1</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">bbox</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">bboxes</span><span class="p">):</span>
        <span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="n">bbox</span>
        <span class="n">center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">xmin</span> <span class="o">+</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymin</span> <span class="o">+</span> <span class="n">ymax</span><span class="p">])</span><span class="o">*</span><span class="mf">0.5</span>
        <span class="n">width_height</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">xmax</span><span class="o">-</span><span class="n">xmin</span><span class="p">,</span> <span class="n">ymax</span><span class="o">-</span><span class="n">ymin</span><span class="p">])</span>
        <span class="c1">#cell widths</span>
        <span class="n">cell_w1</span><span class="p">,</span> <span class="n">cell_w2</span><span class="p">,</span> <span class="n">cell_w3</span> <span class="o">=</span> <span class="n">INPUT_SIZE</span><span class="o">/</span><span class="mf">52.</span><span class="p">,</span> <span class="n">INPUT_SIZE</span><span class="o">/</span><span class="mf">26.</span><span class="p">,</span> <span class="n">INPUT_SIZE</span><span class="o">/</span><span class="mf">13.</span>
        <span class="c1">#normalized center coordinates</span>
        <span class="n">center1</span><span class="p">,</span> <span class="n">center2</span><span class="p">,</span> <span class="n">center3</span> <span class="o">=</span> <span class="n">center</span><span class="o">/</span><span class="n">cell_w1</span><span class="p">,</span> <span class="n">center</span><span class="o">/</span><span class="n">cell_w2</span><span class="p">,</span> <span class="n">center</span><span class="o">/</span><span class="n">cell_w3</span>
        <span class="c1">#cells responsible for the ground truth</span>
        <span class="n">cell_1</span><span class="p">,</span> <span class="n">cell_2</span><span class="p">,</span> <span class="n">cell_3</span> <span class="o">=</span> <span class="p">(</span><span class="n">center1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span> <span class="p">(</span><span class="n">center2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span> <span class="p">(</span><span class="n">center3</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="c1">#confidence score</span>
        <span class="n">scale1</span><span class="p">[</span><span class="n">cell_1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cell_1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">:,</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="c1">#b_x, b_y, b_w, b_h, C, probas</span>
        <span class="n">scale2</span><span class="p">[</span><span class="n">cell_2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cell_2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">:,</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">scale3</span><span class="p">[</span><span class="n">cell_3</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cell_3</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">:,</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="c1">#not 1.0 else problem when inverting</span>
        <span class="c1">#class probability</span>
        <span class="n">num_class</span> <span class="o">=</span> <span class="n">CLASSES_LIST</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">classes</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">scale1</span><span class="p">[</span><span class="n">cell_1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cell_1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">:,</span> <span class="mi">5</span> <span class="o">+</span> <span class="n">num_class</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">scale2</span><span class="p">[</span><span class="n">cell_2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cell_2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">:,</span> <span class="mi">5</span> <span class="o">+</span> <span class="n">num_class</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">scale3</span><span class="p">[</span><span class="n">cell_3</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cell_3</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">:,</span> <span class="mi">5</span> <span class="o">+</span> <span class="n">num_class</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="c1">#b_x, b_y</span>
        <span class="n">scale1</span><span class="p">[</span><span class="n">cell_1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cell_1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">center1</span><span class="o">-</span><span class="n">cell_1</span>
        <span class="n">scale2</span><span class="p">[</span><span class="n">cell_2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cell_2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">center2</span><span class="o">-</span><span class="n">cell_2</span>
        <span class="n">scale3</span><span class="p">[</span><span class="n">cell_3</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cell_3</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">center3</span><span class="o">-</span><span class="n">cell_3</span>
        <span class="c1">#b_w, b_h</span>
        <span class="n">scale1</span><span class="p">[</span><span class="n">cell_1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cell_1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">:,</span> <span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">width_height</span><span class="o">/</span><span class="n">cell_w1</span>
        <span class="n">scale2</span><span class="p">[</span><span class="n">cell_2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cell_2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">:,</span> <span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">width_height</span><span class="o">/</span><span class="n">cell_w2</span>
        <span class="n">scale3</span><span class="p">[</span><span class="n">cell_3</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cell_3</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">:,</span> <span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">width_height</span><span class="o">/</span><span class="n">cell_w3</span>
    <span class="k">return</span> <span class="n">scale1</span><span class="p">,</span> <span class="n">scale2</span><span class="p">,</span> <span class="n">scale3</span>

<span class="k">def</span> <span class="nf">encode</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">anchors</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    x = scale = (N,N,3,5+num_classes) = [[bx,by,bw,bh,conf,probs],[]]</span>
<span class="sd">    output = [[tx,ty,tw,th,t0,probs],[]]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nb_cells</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">x</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">CLASSES_LIST</span><span class="p">)))</span>
    <span class="n">tx</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:,</span><span class="mi">0</span><span class="p">][:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
    <span class="n">ty</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:,</span><span class="mi">1</span><span class="p">][:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
    <span class="n">tw</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:,</span><span class="mi">2</span><span class="p">][:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
    <span class="n">th</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:,</span><span class="mi">3</span><span class="p">][:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
    <span class="n">t0</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:,</span><span class="mi">4</span><span class="p">][:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
    <span class="n">probs</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:,</span><span class="mi">5</span><span class="p">:]</span>
    
    <span class="n">tile_of_cells</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">nb_cells</span><span class="p">,</span> <span class="n">nb_cells</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nb_cells</span><span class="o">**</span><span class="mi">2</span><span class="p">)])</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="n">tile_of_cells</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="n">tile_of_cells</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span> <span class="c1">#convert to one column vector</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">cols</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">BBOXES_PER_CELL</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1">#repeat lines for each box</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">cols</span><span class="p">,</span> <span class="n">BBOXES_PER_CELL</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="c1">#rows = c_y and cols = c_x</span>
    
    <span class="n">tx</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">tx</span><span class="p">,</span> <span class="n">cols</span><span class="p">)</span>
    <span class="n">tx</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">tx</span><span class="p">,</span> <span class="mi">1</span><span class="o">-</span><span class="n">tx</span><span class="p">)</span>
    <span class="n">tx</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">tx</span><span class="p">)</span> <span class="c1">#reciprocal of sigmoid</span>
    <span class="n">tx</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">is_nan</span><span class="p">(</span><span class="n">tx</span><span class="p">),</span> <span class="n">tf</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">tx</span><span class="p">),</span> <span class="n">tx</span><span class="p">)</span> <span class="c1">#remove -inf and nans</span>
    <span class="n">tx</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">is_inf</span><span class="p">(</span><span class="n">tx</span><span class="p">),</span> <span class="n">tf</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">tx</span><span class="p">),</span> <span class="n">tx</span><span class="p">)</span>
    <span class="n">ty</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">ty</span><span class="p">,</span> <span class="n">rows</span><span class="p">)</span>
    <span class="n">ty</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">ty</span><span class="p">,</span> <span class="mi">1</span><span class="o">-</span><span class="n">ty</span><span class="p">))</span>
    <span class="n">ty</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">is_nan</span><span class="p">(</span><span class="n">ty</span><span class="p">),</span> <span class="n">tf</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">ty</span><span class="p">),</span> <span class="n">ty</span><span class="p">)</span>
    <span class="n">ty</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">is_inf</span><span class="p">(</span><span class="n">ty</span><span class="p">),</span> <span class="n">tf</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">ty</span><span class="p">),</span> <span class="n">ty</span><span class="p">)</span>
    <span class="n">anchors_repeat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">anchors</span><span class="p">,</span> <span class="n">nb_cells</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1">#to match the shape of tw</span>
    <span class="n">tw</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">tw</span><span class="p">),</span> <span class="n">anchors_repeat</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">][:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">])</span>
    <span class="n">tw</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">is_inf</span><span class="p">(</span><span class="n">tw</span><span class="p">),</span> <span class="n">tf</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">tw</span><span class="p">),</span> <span class="n">tw</span><span class="p">)</span>
    <span class="n">th</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">th</span><span class="p">),</span> <span class="n">anchors_repeat</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">][:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">])</span>
    <span class="n">th</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">is_inf</span><span class="p">(</span><span class="n">th</span><span class="p">),</span> <span class="n">tf</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">th</span><span class="p">),</span> <span class="n">th</span><span class="p">)</span>
    <span class="n">t0</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">t0</span><span class="p">,</span> <span class="mi">1</span><span class="o">-</span><span class="n">t0</span><span class="p">))</span>
  
    <span class="n">result</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">tx</span><span class="p">,</span> <span class="n">ty</span><span class="p">,</span> <span class="n">tw</span><span class="p">,</span> <span class="n">th</span><span class="p">,</span> <span class="n">t0</span><span class="p">,</span> <span class="n">probs</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="p">(</span><span class="n">nb_cells</span><span class="p">,</span> <span class="n">nb_cells</span><span class="p">,</span> <span class="n">BBOXES_PER_CELL</span><span class="o">*</span><span class="p">(</span><span class="mi">5</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">CLASSES_LIST</span><span class="p">))))</span>
    <span class="k">return</span> <span class="n">result</span>

<span class="k">def</span> <span class="nf">decode</span><span class="p">(</span><span class="n">scale</span><span class="p">,</span> <span class="n">anchors</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    input: scale1 or scale2 or scale3 (batch_size, S, S, 255)</span>
<span class="sd">    output: (batch_size*S*S*3, 5 + num_classes)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nb_cells</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">scale</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">scale</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Reshape</span><span class="p">((</span><span class="n">nb_cells</span><span class="o">*</span><span class="n">nb_cells</span><span class="o">*</span><span class="n">BBOXES_PER_CELL</span><span class="p">,</span> <span class="mi">5</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">CLASSES_LIST</span><span class="p">)))(</span><span class="n">scale</span><span class="p">)</span> <span class="c1">#(batch_size, S*S*3, 7)</span>
    <span class="n">tx</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="n">scale</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nb_cells</span><span class="o">*</span><span class="n">nb_cells</span><span class="o">*</span><span class="n">BBOXES_PER_CELL</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">ty</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="n">scale</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nb_cells</span><span class="o">*</span><span class="n">nb_cells</span><span class="o">*</span><span class="n">BBOXES_PER_CELL</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">tw</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="n">scale</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nb_cells</span><span class="o">*</span><span class="n">nb_cells</span><span class="o">*</span><span class="n">BBOXES_PER_CELL</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">th</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="n">scale</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nb_cells</span><span class="o">*</span><span class="n">nb_cells</span><span class="o">*</span><span class="n">BBOXES_PER_CELL</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">t0</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="n">scale</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nb_cells</span><span class="o">*</span><span class="n">nb_cells</span><span class="o">*</span><span class="n">BBOXES_PER_CELL</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">probs</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="n">scale</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nb_cells</span><span class="o">*</span><span class="n">nb_cells</span><span class="o">*</span><span class="n">BBOXES_PER_CELL</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">CLASSES_LIST</span><span class="p">)])</span>
    
    <span class="n">tile_of_cells</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">nb_cells</span><span class="p">,</span> <span class="n">nb_cells</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nb_cells</span><span class="o">**</span><span class="mi">2</span><span class="p">)])</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="n">tile_of_cells</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="n">tile_of_cells</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span> <span class="c1">#convert to one column vector</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">cols</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">BBOXES_PER_CELL</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1">#repeat lines for each box</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">cols</span><span class="p">,</span> <span class="n">BBOXES_PER_CELL</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)[</span><span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="c1">#(1, S*S*3, 1) to take the batch size into account</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">cols</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)[</span><span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
    <span class="c1">#rows = c_y and cols = c_x</span>
    <span class="n">bx</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Add</span><span class="p">()([</span><span class="n">tx</span><span class="p">,</span> <span class="n">cols</span><span class="p">])</span>
    <span class="n">by</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Add</span><span class="p">()([</span><span class="n">ty</span><span class="p">,</span> <span class="n">rows</span><span class="p">])</span>
    <span class="n">anchors_repeat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">anchors</span><span class="p">,</span> <span class="n">nb_cells</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1">#to match the shape of tw</span>
    <span class="n">anchors_w</span> <span class="o">=</span> <span class="n">anchors_repeat</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">][:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="c1">#transform into column and then add batch_size dim</span>
    <span class="n">anchors_h</span> <span class="o">=</span> <span class="n">anchors_repeat</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">][:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
    
    <span class="n">bw</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">activations</span><span class="o">.</span><span class="n">exponential</span><span class="p">(</span><span class="n">tw</span><span class="p">)</span>
    <span class="n">bw</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Multiply</span><span class="p">()([</span><span class="n">anchors_w</span><span class="p">,</span> <span class="n">bw</span><span class="p">])</span>
    <span class="n">bh</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">activations</span><span class="o">.</span><span class="n">exponential</span><span class="p">(</span><span class="n">th</span><span class="p">)</span>
    <span class="n">bh</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Multiply</span><span class="p">()([</span><span class="n">anchors_h</span><span class="p">,</span> <span class="n">bh</span><span class="p">])</span>
    <span class="n">t0</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">activations</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">t0</span><span class="p">)</span>
    
    <span class="n">scale</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Concatenate</span><span class="p">(</span><span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)([</span><span class="n">bx</span><span class="p">,</span> <span class="n">by</span><span class="p">,</span> <span class="n">bw</span><span class="p">,</span> <span class="n">bh</span><span class="p">,</span> <span class="n">t0</span><span class="p">,</span> <span class="n">probs</span><span class="p">])</span>
  
    <span class="k">return</span> <span class="n">scale</span>

<span class="k">def</span> <span class="nf">bbox_back_to_scale</span><span class="p">(</span><span class="n">y</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    input: y (13*13*3,255) tensor </span>
<span class="sd">    convert [bx,by,bw,bh] to [xmin,ymin,xmax,ymax] </span>
<span class="sd">    outputs a (N*N*3, 5+num_classes) vector</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">bboxes</span> <span class="o">=</span> <span class="n">y</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">4</span><span class="p">]</span>
    <span class="c1">#convert to xmin, ymin, xmax, ymax and reshape to vector</span>
    <span class="n">bx</span> <span class="o">=</span> <span class="n">bboxes</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">by</span> <span class="o">=</span> <span class="n">bboxes</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">bw</span> <span class="o">=</span> <span class="n">bboxes</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>
    <span class="n">bh</span> <span class="o">=</span> <span class="n">bboxes</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span>
    <span class="c1">#the bx and by are expressed in the referencial of the cell, we have to add (x_cell,y_cell)*dim_cell</span>
    <span class="n">nb_cells</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">bboxes</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">BBOXES_PER_CELL</span><span class="p">))</span>
    <span class="n">tile_of_cells</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">nb_cells</span><span class="p">,</span> <span class="n">nb_cells</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nb_cells</span><span class="o">**</span><span class="mi">2</span><span class="p">)])</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="n">tile_of_cells</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="n">tile_of_cells</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">BBOXES_PER_CELL</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">cols</span><span class="p">,</span> <span class="n">BBOXES_PER_CELL</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">bx</span> <span class="o">=</span> <span class="n">bx</span> <span class="o">+</span> <span class="n">rows</span>
    <span class="c1">#convert bx,by,bw,bh to xmin,ymin,xmax,ymax</span>
    <span class="n">by</span> <span class="o">=</span> <span class="n">by</span> <span class="o">+</span> <span class="n">cols</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">xmin</span> <span class="o">=</span> <span class="p">(</span><span class="n">bx</span><span class="o">-</span><span class="n">bw</span><span class="o">/</span><span class="mi">2</span><span class="p">)[:,</span> <span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
    <span class="n">ymin</span> <span class="o">=</span> <span class="p">(</span><span class="n">by</span><span class="o">-</span><span class="n">bh</span><span class="o">/</span><span class="mi">2</span><span class="p">)[:,</span> <span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
    <span class="n">xmax</span> <span class="o">=</span> <span class="p">(</span><span class="n">bx</span><span class="o">+</span><span class="n">bw</span><span class="o">/</span><span class="mi">2</span><span class="p">)[:,</span> <span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
    <span class="n">ymax</span> <span class="o">=</span> <span class="p">(</span><span class="n">by</span><span class="o">+</span><span class="n">bh</span><span class="o">/</span><span class="mi">2</span><span class="p">)[:,</span> <span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
    <span class="n">bboxes</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymax</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">stop</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">bboxes</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">bboxes</span><span class="o">*</span><span class="n">INPUT_SIZE</span><span class="o">/</span><span class="n">nb_cells</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="n">bboxes</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">bboxes</span><span class="p">,</span> <span class="n">y</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">bboxes</span><span class="p">,</span><span class="n">y</span><span class="p">[:,</span><span class="mi">4</span><span class="p">:]],</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">y</span>

<span class="k">def</span> <span class="nf">non_max_suppression</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">iou_threshhold</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">obj_threshhold</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    input: y=[[bx,by,bw,bh,conf,probas],[]] (13*13*3+26*26*3+52*52+*3, 5+num_classes)</span>
<span class="sd">    for the evaluation, not training (batch_size = 1 and shape(y)=(13,13,255))</span>
<span class="sd">    returns y as a (13*13*3 + 26*26*3 + 52*52+3, [xmin,xmax,ymin,ymax,class_id,class_prob]) tensor</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#eliminate low objectness rows</span>
    <span class="n">cond</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">y</span><span class="p">[:,</span><span class="mi">4</span><span class="p">]</span><span class="o">&lt;=</span><span class="n">obj_threshhold</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">)[:,</span> <span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
    <span class="n">cond</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">cond</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">y</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">()])</span> <span class="c1">#has to have the same number of columns as y</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">boolean_mask</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">cond</span><span class="p">)</span> <span class="c1">#returns a one row vector so we have to reshape it</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">CLASSES_LIST</span><span class="p">)))</span>
    <span class="c1">#assign the detection to the maximum probability</span>
    <span class="n">bboxes</span> <span class="o">=</span> <span class="n">y</span><span class="p">[:,:</span><span class="mi">4</span><span class="p">]</span>
    <span class="n">conf</span> <span class="o">=</span> <span class="n">y</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">]</span>
    <span class="n">probs</span> <span class="o">=</span> <span class="n">y</span><span class="p">[:,</span> <span class="mi">5</span><span class="p">:]</span>
    <span class="c1">#iterate over the probs = [[p1,p2,...,pn],[p1,p2,...,pn],...]</span>
    <span class="n">new_probs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">prob</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">probs</span><span class="p">):</span>
        <span class="n">class_id</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">prob</span><span class="p">)</span>
        <span class="n">new_probs</span><span class="o">+=</span><span class="p">[[</span><span class="n">class_id</span><span class="p">,</span><span class="n">prob</span><span class="p">[</span><span class="n">class_id</span><span class="p">]]]</span>
    <span class="n">new_probs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">new_probs</span><span class="p">[:])</span>
    <span class="n">new_probs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">new_probs</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span> <span class="c1">#for when new_probs is empty</span>
    <span class="n">classes_id</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">new_probs</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="c1">#returns an array without repetition</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">bool</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">y</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">())[:,</span> <span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">y</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">()])</span>
    <span class="k">for</span> <span class="n">class_id</span> <span class="ow">in</span> <span class="n">classes_id</span><span class="p">:</span>
        <span class="n">class_confs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">new_probs</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="n">class_id</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span> <span class="c1">#keeps the indexing of probs</span>
        <span class="n">class_confs</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">tile</span><span class="p">([</span><span class="n">class_confs</span><span class="p">],</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">bboxes</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">class_confs</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">class_confs</span><span class="p">)</span>
        <span class="n">indexes</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">class_confs</span><span class="p">)[</span><span class="mi">0</span><span class="p">])]</span>
        <span class="n">max_conf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">class_confs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="c1">#get the index of the box with the highest confidence score</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">indexes</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span><span class="c1">#check all the boxes</span>
            <span class="c1">#print(&#39;indexes&#39;, indexes)</span>
            <span class="n">pred</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">tile</span><span class="p">([</span><span class="n">bboxes</span><span class="p">[</span><span class="n">max_conf</span><span class="p">]],</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">bboxes</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">])</span> <span class="c1">#create a vector with only bboxes[max_conf] to calculate IOU in one pass</span>
            <span class="n">bboxes_filtered</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">class_confs</span><span class="o">==</span><span class="mf">0.</span><span class="p">,</span><span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">bboxes</span><span class="p">)),</span><span class="n">bboxes</span><span class="p">)</span> <span class="c1">#we make sure the iou for bboxes of other classes won&#39;t be &gt; 0.5</span>
            <span class="n">bboxes_filtered</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">bboxes_filtered</span><span class="p">)</span> <span class="c1">#convert to tensor</span>
            <span class="n">iou</span> <span class="o">=</span> <span class="n">IOU</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="n">bboxes_filtered</span><span class="p">)</span>
            <span class="n">iou</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">is_nan</span><span class="p">(</span><span class="n">iou</span><span class="p">),</span> <span class="n">tf</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">iou</span><span class="p">),</span> <span class="n">iou</span><span class="p">)</span> <span class="c1">#check for nans (boxes that are too little)</span>
            <span class="n">new_mask</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">iou</span><span class="o">&gt;</span><span class="n">iou_threshhold</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">)[:,</span> <span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
            <span class="n">new_mask</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">new_mask</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">y</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">()])</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">new_mask</span><span class="p">)</span> <span class="c1">#we update the mask to remove the bboxes for which iou &gt; 0.5  </span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
            <span class="n">mask_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">mask</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span> <span class="c1">#mask for the index</span>
            <span class="n">mask</span><span class="p">[</span><span class="n">max_conf</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="kc">True</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">mask</span><span class="p">)[</span><span class="mi">1</span><span class="p">])]</span> <span class="c1">#since iou with itself = 1, the prediction was removed </span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mask_index</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">val</span> <span class="ow">and</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indexes</span><span class="p">:</span> <span class="c1">#maybe we already removed it</span>
                    <span class="n">indexes</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">indexes</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span> <span class="c1">#check if we didn&#39;t deleted it all in the previous steps</span>
                <span class="n">max_conf</span> <span class="o">=</span> <span class="n">indexes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1">#and then iterate over all remaining boxes</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">boolean_mask</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="p">[:,:</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">new_probs</span><span class="p">)[</span><span class="mi">1</span><span class="p">]]</span> <span class="c1">#to match shapes</span>
    <span class="n">new_probs</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">boolean_mask</span><span class="p">(</span><span class="n">new_probs</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>
    <span class="n">new_probs</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">new_probs</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">CLASSES_LIST</span><span class="p">)))</span>
    <span class="n">new_probs</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">new_probs</span><span class="p">,</span> <span class="n">y</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">y</span><span class="p">[:,:</span><span class="mi">4</span><span class="p">],</span><span class="n">new_probs</span><span class="p">],</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">y</span>

<span class="k">def</span> <span class="nf">bboxes_postprocess</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">org_img_shape</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    y is a (N*N*3,255) tensor</span>
<span class="sd">    returns a (N*N*3,255) tensor</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">bboxes</span> <span class="o">=</span> <span class="n">y</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">4</span><span class="p">]</span>
    <span class="n">remainder</span> <span class="o">=</span> <span class="n">y</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">:]</span>
    <span class="c1"># convert to original aspect ratio</span>
    <span class="n">org_h</span><span class="p">,</span> <span class="n">org_w</span> <span class="o">=</span> <span class="n">org_img_shape</span>
    <span class="n">resize_ratio</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">INPUT_SIZE</span><span class="o">/</span><span class="n">org_w</span><span class="p">,</span> <span class="n">INPUT_SIZE</span><span class="o">/</span><span class="n">org_h</span><span class="p">)</span>
    <span class="n">dw</span> <span class="o">=</span> <span class="p">(</span><span class="n">INPUT_SIZE</span> <span class="o">-</span> <span class="n">resize_ratio</span> <span class="o">*</span> <span class="n">org_w</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">dh</span> <span class="o">=</span> <span class="p">(</span><span class="n">INPUT_SIZE</span> <span class="o">-</span> <span class="n">resize_ratio</span> <span class="o">*</span> <span class="n">org_h</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">xmin</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">bboxes</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">dw</span><span class="p">),</span> <span class="n">resize_ratio</span><span class="p">)</span>
    <span class="n">xmax</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">bboxes</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">dw</span><span class="p">),</span> <span class="n">resize_ratio</span><span class="p">)</span>
    <span class="n">ymin</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">bboxes</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">dh</span><span class="p">),</span> <span class="n">resize_ratio</span><span class="p">)</span>
    <span class="n">ymax</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">bboxes</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">],</span> <span class="n">dh</span><span class="p">),</span> <span class="n">resize_ratio</span><span class="p">)</span>
    <span class="c1">#clip boxes that are out of range</span>
    <span class="n">xmin</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">clip_by_value</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">org_w</span><span class="p">)[:,</span> <span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="c1">#convert row to column vector</span>
    <span class="n">xmax</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">clip_by_value</span><span class="p">(</span><span class="n">xmax</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">org_w</span><span class="p">)[:,</span> <span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
    <span class="n">ymin</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">clip_by_value</span><span class="p">(</span><span class="n">ymin</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">org_h</span><span class="p">)[:,</span> <span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
    <span class="n">ymax</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">clip_by_value</span><span class="p">(</span><span class="n">ymax</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">org_h</span><span class="p">)[:,</span> <span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
    
    <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="n">remainder</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">draw_bboxes</span><span class="p">(</span><span class="n">bboxes</span><span class="p">,</span> <span class="n">image</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    bboxes = [[xmin,ymin,ymax,class_id,proba],[]]</span>
<span class="sd">    cv2 rectangle: top left, bottom right (y axis downwards)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">bbox_thick</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">0.6</span> <span class="o">*</span> <span class="p">(</span><span class="n">h</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span> <span class="o">/</span> <span class="mi">200</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">bbox</span> <span class="ow">in</span> <span class="n">bboxes</span><span class="p">:</span>
        <span class="n">xmin</span><span class="p">,</span><span class="n">ymin</span><span class="p">,</span><span class="n">xmax</span><span class="p">,</span><span class="n">ymax</span><span class="p">,</span><span class="n">class_id</span><span class="p">,</span><span class="n">score</span> <span class="o">=</span> <span class="n">bbox</span>
        <span class="k">if</span> <span class="n">is_bbox_in_danger_zone</span><span class="p">(</span><span class="n">bbox</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">):</span>
            <span class="n">color</span> <span class="o">=</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="c1">#danger</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="n">color</span> <span class="o">=</span> <span class="n">COLORS</span><span class="p">[</span><span class="n">class_id</span><span class="p">]</span>
        <span class="n">cv2</span><span class="o">.</span><span class="n">rectangle</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="p">(</span><span class="n">xmin</span><span class="p">,</span><span class="n">ymin</span><span class="p">),</span> <span class="p">(</span><span class="n">xmax</span><span class="p">,</span><span class="n">ymax</span><span class="p">),</span> <span class="n">color</span><span class="p">,</span> <span class="n">bbox_thick</span><span class="p">)</span>
        <span class="n">bbox_mess</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">: </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">DISPLAY_CLASSES_LIST</span><span class="p">[</span><span class="n">class_id</span><span class="p">],</span> <span class="n">score</span><span class="p">)</span>
        <span class="n">t_size</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">getTextSize</span><span class="p">(</span><span class="n">bbox_mess</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">thickness</span><span class="o">=</span><span class="n">bbox_thick</span><span class="o">//</span><span class="mi">2</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">cv2</span><span class="o">.</span><span class="n">rectangle</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="p">(</span><span class="n">xmin</span><span class="p">,</span><span class="n">ymin</span><span class="p">),</span> <span class="p">(</span><span class="n">xmin</span> <span class="o">+</span> <span class="n">t_size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ymin</span> <span class="o">-</span> <span class="n">t_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">3</span><span class="p">),</span> <span class="n">color</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">cv2</span><span class="o">.</span><span class="n">putText</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">bbox_mess</span><span class="p">,</span> <span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span><span class="o">-</span><span class="mi">2</span><span class="p">),</span> <span class="n">cv2</span><span class="o">.</span><span class="n">FONT_HERSHEY_SIMPLEX</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">bbox_thick</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="n">lineType</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">LINE_AA</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">image</span>

<span class="k">def</span> <span class="nf">draw_danger_zone</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">y_lim</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="mi">6</span><span class="p">):</span>
    <span class="n">h</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
    <span class="n">overlay</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">slope</span> <span class="o">=</span> <span class="n">w</span><span class="o">/</span><span class="n">h</span> <span class="c1"># on cherche x en imposant y</span>
    <span class="n">y_lim</span> <span class="o">=</span> <span class="n">y_lim</span><span class="o">*</span><span class="n">h</span>
    <span class="n">pts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="n">h</span><span class="p">],[</span><span class="n">slope</span><span class="o">*</span><span class="n">y_lim</span><span class="p">,</span><span class="n">h</span><span class="o">-</span><span class="n">y_lim</span><span class="p">],[</span><span class="n">w</span><span class="o">-</span><span class="n">slope</span><span class="o">*</span><span class="n">y_lim</span><span class="p">,</span><span class="n">h</span><span class="o">-</span><span class="n">y_lim</span><span class="p">],[</span><span class="n">w</span><span class="p">,</span><span class="n">h</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="n">h</span><span class="p">]],</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="n">pts</span> <span class="o">=</span> <span class="n">pts</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">polylines</span><span class="p">(</span><span class="n">overlay</span><span class="p">,[</span><span class="n">pts</span><span class="p">],</span><span class="kc">False</span><span class="p">,(</span><span class="mi">255</span><span class="p">,</span><span class="mi">255</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span><span class="mi">8</span><span class="p">)</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">addWeighted</span><span class="p">(</span><span class="n">overlay</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">alpha</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">image</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">image</span>

<span class="k">def</span> <span class="nf">is_bbox_in_danger_zone</span><span class="p">(</span><span class="n">bbox</span><span class="p">,</span> <span class="n">img_shape</span><span class="p">,</span> <span class="n">y_lim</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="mi">6</span><span class="p">):</span>
    <span class="n">h</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="n">img_shape</span>
    <span class="n">slope</span> <span class="o">=</span> <span class="n">w</span><span class="o">/</span><span class="n">h</span>
    <span class="n">y_lim</span> <span class="o">=</span> <span class="n">y_lim</span><span class="o">*</span><span class="n">h</span>
    <span class="n">x1</span><span class="p">,</span><span class="n">y1</span><span class="p">,</span><span class="n">x3</span><span class="p">,</span><span class="n">y3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">bbox</span><span class="p">[:</span><span class="mi">4</span><span class="p">])</span>
    <span class="n">x2</span><span class="p">,</span><span class="n">y2</span><span class="p">,</span><span class="n">x4</span><span class="p">,</span><span class="n">y4</span> <span class="o">=</span> <span class="n">x3</span><span class="p">,</span><span class="n">y1</span><span class="p">,</span><span class="n">x1</span><span class="p">,</span><span class="n">y3</span>
    <span class="n">cond</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">for</span> <span class="n">coord</span> <span class="ow">in</span> <span class="p">[[</span><span class="n">x1</span><span class="p">,</span><span class="n">y1</span><span class="p">],</span> <span class="p">[</span><span class="n">x2</span><span class="p">,</span><span class="n">y2</span><span class="p">],</span> <span class="p">[</span><span class="n">x3</span><span class="p">,</span><span class="n">y3</span><span class="p">],</span> <span class="p">[</span><span class="n">x4</span><span class="p">,</span><span class="n">y4</span><span class="p">]]:</span>
        <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="o">=</span> <span class="n">coord</span>
        <span class="n">cond</span> <span class="o">=</span> <span class="n">cond</span> <span class="ow">or</span> <span class="p">((</span><span class="n">j</span> <span class="o">&gt;</span> <span class="n">h</span><span class="o">-</span><span class="n">y_lim</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="n">slope</span><span class="o">*</span><span class="p">(</span><span class="n">h</span><span class="o">-</span><span class="n">j</span><span class="p">))</span> <span class="ow">and</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">w</span><span class="o">-</span><span class="n">slope</span><span class="o">*</span><span class="p">(</span><span class="n">h</span><span class="o">-</span><span class="n">j</span><span class="p">)))</span>
    <span class="k">if</span> <span class="n">cond</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="kc">False</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Testing-the-ground-truth-pre-process-and-the-output-post-process">Testing the ground-truth pre-process and the output post-process<a class="anchor-link" href="#Testing-the-ground-truth-pre-process-and-the-output-post-process">&#182;</a></h2><p>Let's pre-process a ground-truth image and post-process it as if it was the output of the network</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[7]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#EVAL ONE IMAGE</span>
<span class="n">image_org</span> <span class="o">=</span> <span class="s1">&#39;FudanPed00001.jpg&#39;</span>
<span class="n">image_org</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">image_org</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">image_org</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">image_org</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2RGB</span><span class="p">)</span>
<span class="n">img_shape</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">image_org</span><span class="p">)[:</span><span class="mi">2</span><span class="p">]</span>
<span class="n">bboxes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;160&#39;</span><span class="p">,</span> <span class="s1">&#39;182&#39;</span><span class="p">,</span> <span class="s1">&#39;302&#39;</span><span class="p">,</span> <span class="s1">&#39;431&#39;</span><span class="p">,</span> <span class="s1">&#39;420&#39;</span><span class="p">,</span> <span class="s1">&#39;171&#39;</span><span class="p">,</span> <span class="s1">&#39;535&#39;</span><span class="p">,</span> <span class="s1">&#39;486&#39;</span><span class="p">]</span>
<span class="n">bboxes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">bboxes</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="n">bboxes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">bboxes</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="n">classes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Distracted Person&#39;</span><span class="p">,</span> <span class="s1">&#39;Distracted Person&#39;</span><span class="p">]</span>
<span class="n">y_true</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;classes&#39;</span><span class="p">:</span><span class="n">classes</span><span class="p">,</span> <span class="s1">&#39;bboxes&#39;</span><span class="p">:</span><span class="n">bboxes</span><span class="p">}</span>
<span class="n">image</span><span class="p">,</span> <span class="n">y_true</span><span class="p">[</span><span class="s1">&#39;bboxes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">image_preprocess</span><span class="p">(</span><span class="n">image_org</span><span class="p">,</span> <span class="n">y_true</span><span class="p">[</span><span class="s1">&#39;bboxes&#39;</span><span class="p">])</span>
<span class="n">scale1</span><span class="p">,</span> <span class="n">scale2</span><span class="p">,</span> <span class="n">scale3</span> <span class="o">=</span> <span class="n">ground_truth_preprocess</span><span class="p">(</span><span class="n">y_true</span><span class="p">[</span><span class="s1">&#39;classes&#39;</span><span class="p">],</span> <span class="n">y_true</span><span class="p">[</span><span class="s1">&#39;bboxes&#39;</span><span class="p">])</span>
<span class="n">start_postprocess</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">scale1</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">scale1</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">CLASSES_LIST</span><span class="p">)))</span>
<span class="n">scale2</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">scale2</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">CLASSES_LIST</span><span class="p">)))</span>
<span class="n">scale3</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">scale3</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">CLASSES_LIST</span><span class="p">)))</span>
<span class="n">scale1</span> <span class="o">=</span> <span class="n">bbox_back_to_scale</span><span class="p">(</span><span class="n">scale1</span><span class="p">)</span>
<span class="n">scale2</span> <span class="o">=</span> <span class="n">bbox_back_to_scale</span><span class="p">(</span><span class="n">scale2</span><span class="p">)</span>
<span class="n">scale3</span> <span class="o">=</span> <span class="n">bbox_back_to_scale</span><span class="p">(</span><span class="n">scale3</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">scale1</span><span class="p">,</span> <span class="n">scale2</span><span class="p">,</span> <span class="n">scale3</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">non_max_suppression</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">bboxes_postprocess</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">img_shape</span><span class="p">)</span>
<span class="n">image</span> <span class="o">=</span> <span class="n">draw_bboxes</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">image_org</span><span class="p">)</span>
<span class="n">image</span> <span class="o">=</span> <span class="n">draw_danger_zone</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image</span><span class="p">);</span>
<span class="n">stop_postprocess</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;postprocess: </span><span class="si">{}</span><span class="s1"> s&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">stop_postprocess</span> <span class="o">-</span> <span class="n">start_postprocess</span><span class="p">,</span> <span class="mi">3</span><span class="p">)))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<p align="center">
    <img src="output_10_1.png" class='img-fluid' width="300rem"/>
</p>
    
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Training-the-model">Training the model<a class="anchor-link" href="#Training-the-model">&#182;</a></h2><p>We train the model using the mean squared error loss function, as the <a href="https://arxiv.org/abs/1804.02767">original publication</a> suggests.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[8]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">checkpoint_path</span> <span class="o">=</span> <span class="s2">&quot;yolov3_coco.ckpt&quot;</span>

<span class="n">cp_callback</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">ModelCheckpoint</span><span class="p">(</span>
    <span class="n">checkpoint_path</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">save_weights_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="c1"># Save weights, every 5-epochs.</span>
    <span class="n">save_freq</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[9]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">inputs</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">INPUT_SIZE</span><span class="p">,</span> <span class="n">INPUT_SIZE</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">scale1</span><span class="p">,</span> <span class="n">scale2</span><span class="p">,</span> <span class="n">scale3</span> <span class="o">=</span> <span class="n">darknet53</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span> <span class="c1"># shape = (None, 52*52*3, 5 + num classes)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="p">[</span><span class="n">scale1</span><span class="p">,</span> <span class="n">scale2</span><span class="p">,</span> <span class="n">scale3</span><span class="p">])</span>

<span class="c1"># Compile the model</span>
<span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Adam</span><span class="p">(),</span>
              <span class="n">loss</span><span class="o">=</span><span class="s1">&#39;mean_squared_error&#39;</span><span class="p">,</span> <span class="c1">#the function is applied for each output</span>
              <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">])</span>

<span class="n">model</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Replace the three arrays <code>train_scale1</code>,<code>train_scale2</code> and <code>train_scale3</code> with the ground truths of the data set for each scale.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[&nbsp;]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># train</span>
<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_images</span><span class="p">,</span> <span class="p">[</span><span class="n">train_scale1</span><span class="p">,</span> <span class="n">train_scale2</span><span class="p">,</span> <span class="n">train_scale3</span><span class="p">],</span>
                    <span class="n">batch_size</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
                    <span class="n">epochs</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
                    <span class="n">validation_split</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
                    <span class="n">callbacks</span> <span class="o">=</span> <span class="p">[</span><span class="n">cp_callback</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Load-pre-trained-weights">Load pre-trained weights<a class="anchor-link" href="#Load-pre-trained-weights">&#182;</a></h2><p>We load pre-trained weights on the <a href="http://cocodataset.org/">COCO Dataset</a> available on the <a href="https://pjreddie.com/darknet/yolo/">original YOLOv3 website</a>.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[73]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#Load pre-trained weights</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;yolov3.weights&#39;</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
    <span class="n">pretrained_weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Number of pretrained weights from Darknet : </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">pretrained_weights</span><span class="p">)[</span><span class="mi">0</span><span class="p">]))</span>
<span class="n">used_weights</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">layers</span><span class="p">)):</span>
    <span class="n">layer_weights</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">get_weights</span><span class="p">()</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">layer_weights</span><span class="p">)):</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">layer_weights</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
        <span class="n">shape_w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">nb_w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">w</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">new_weights</span> <span class="o">=</span> <span class="n">pretrained_weights</span><span class="p">[</span><span class="n">used_weights</span><span class="p">:</span><span class="n">used_weights</span> <span class="o">+</span> <span class="n">nb_w</span><span class="p">]</span>
        <span class="n">new_weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">new_weights</span><span class="p">,</span> <span class="n">shape_w</span><span class="p">)</span>
        <span class="n">weights</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_weights</span><span class="p">)</span>
        <span class="n">used_weights</span><span class="o">+=</span><span class="n">nb_w</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_weights</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> weights used.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">used_weights</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt"></div>


<div class="output_subarea output_stream output_stdout output_text">
<pre>Number of pretrained weights from Darknet : 62001762
46642181 weights used.
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We can also load weights from previous trainings:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[9]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#LOAD WEIGHTS</span>
<span class="n">model</span><span class="o">.</span><span class="n">load_weights</span><span class="p">(</span><span class="s1">&#39;weights/weights.h5&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Testing-the-model">Testing the model<a class="anchor-link" href="#Testing-the-model">&#182;</a></h2><p>We test how the model performs on the test dataset (replace the inputs by the right arrays).</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[349]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_loss</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">test_images</span><span class="p">,</span> <span class="p">[</span><span class="n">test_scale1</span><span class="p">,</span> <span class="n">test_scale2</span><span class="p">,</span> <span class="n">test_scale3</span><span class="p">],</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">10</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Test loss:&#39;</span><span class="p">,</span> <span class="n">test_loss</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt"></div>


<div class="output_subarea output_stream output_stdout output_text">
<pre>78/78 - 36s - loss: 157514.8117 - concatenate_97_loss: 395.5134 - concatenate_98_loss: 1419.2120 - concatenate_99_loss: 157114.5938 - concatenate_97_accuracy: 0.4320 - concatenate_98_accuracy: 0.0024 - concatenate_99_accuracy: 0.0089
Test loss: [157514.81169871794, 395.51343, 1419.212, 157114.6, 0.4320048, 0.002446518, 0.00887574]
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Running-inference">Running inference<a class="anchor-link" href="#Running-inference">&#182;</a></h2><p>We can then run inference on the model we just trained</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[&nbsp;]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">start_preprocess</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="n">image_org</span> <span class="o">=</span> <span class="s1">&#39;FudanPed00001.jpg&#39;</span>
<span class="n">image_org</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">image_org</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">image_org</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">image_org</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2RGB</span><span class="p">)</span>
<span class="n">img_shape</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">image_org</span><span class="p">)[:</span><span class="mi">2</span><span class="p">]</span>
<span class="n">bboxes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;160&#39;</span><span class="p">,</span> <span class="s1">&#39;182&#39;</span><span class="p">,</span> <span class="s1">&#39;302&#39;</span><span class="p">,</span> <span class="s1">&#39;431&#39;</span><span class="p">,</span> <span class="s1">&#39;420&#39;</span><span class="p">,</span> <span class="s1">&#39;171&#39;</span><span class="p">,</span> <span class="s1">&#39;535&#39;</span><span class="p">,</span> <span class="s1">&#39;486&#39;</span><span class="p">]</span>
<span class="n">bboxes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">bboxes</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="n">bboxes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">bboxes</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="n">image</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">image_preprocess</span><span class="p">(</span><span class="n">image_org</span><span class="p">,</span> <span class="n">bboxes</span><span class="p">)</span>
<span class="n">image</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">convert_to_tensor</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
<span class="n">image</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">INPUT_SIZE</span><span class="p">,</span> <span class="n">INPUT_SIZE</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>

<span class="n">start_prediction</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">scale1</span><span class="p">,</span> <span class="n">scale2</span><span class="p">,</span> <span class="n">scale3</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">image</span><span class="p">)</span> <span class="c1"># (1,52*52*3,5+num_classes) -&gt; deja decode</span>
<span class="n">start_postprocess</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">scale1</span> <span class="o">=</span> <span class="n">bbox_back_to_scale</span><span class="p">(</span><span class="n">scale1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">scale2</span> <span class="o">=</span> <span class="n">bbox_back_to_scale</span><span class="p">(</span><span class="n">scale2</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">scale3</span> <span class="o">=</span> <span class="n">bbox_back_to_scale</span><span class="p">(</span><span class="n">scale3</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">scale1</span><span class="p">,</span> <span class="n">scale2</span><span class="p">,</span> <span class="n">scale3</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">non_max_suppression</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">bboxes_postprocess</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">img_shape</span><span class="p">)</span>
<span class="n">image_org</span> <span class="o">=</span> <span class="n">draw_danger_zone</span><span class="p">(</span><span class="n">image_org</span><span class="p">)</span>
<span class="n">image</span> <span class="o">=</span> <span class="n">draw_bboxes</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">image_org</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image_org</span><span class="p">);</span>
<span class="n">stop</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;preprocess: </span><span class="si">{}</span><span class="s1"> s&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">start_prediction</span> <span class="o">-</span> <span class="n">start_preprocess</span><span class="p">,</span> <span class="mi">3</span><span class="p">)))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;prediction: </span><span class="si">{}</span><span class="s1"> s&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">start_postprocess</span> <span class="o">-</span> <span class="n">start_prediction</span><span class="p">,</span> <span class="mi">3</span><span class="p">)))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;post-process: </span><span class="si">{}</span><span class="s1"> s&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">stop</span> <span class="o">-</span> <span class="n">start_postprocess</span><span class="p">,</span> <span class="mi">3</span><span class="p">)))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;total time: </span><span class="si">{}</span><span class="s1"> s&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">stop</span> <span class="o">-</span> <span class="n">start_preprocess</span><span class="p">,</span> <span class="mi">3</span><span class="p">)))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;fps: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="n">stop</span> <span class="o">-</span> <span class="n">start_preprocess</span><span class="p">),</span> <span class="mi">3</span><span class="p">)))</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Saving-the-weights-from-our-training">Saving the weights from our training<a class="anchor-link" href="#Saving-the-weights-from-our-training">&#182;</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[21]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#SAVE WEIGHTS</span>
<span class="n">model</span><span class="o">.</span><span class="n">save_weights</span><span class="p">(</span><span class="s1">&#39;weights_</span><span class="si">{}</span><span class="s1">.h5&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">_%H:%M:%S&quot;</span><span class="p">)))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    </div>
  </div>
</body>
</html>
<script src='../scroll-fade.js'></script>
<!-- scripts particles-->
<script src="../js/particles.js"></script>
<script src="../js/app.js"></script>